# 機能仕様書

## 1. 概要
YouTube用の動画作成アプリケーション。
ゆっくり解説やずんだもん解説のような、キャラクターが会話形式、あるいはソロで解説を行う動画を生成する。
UIはWindowsネイティブ(WinUI 3)で実装し、コアロジック(音声合成、アニメーション、動画生成)はPythonのFastAPIサーバーとして動作し、連携を行う。

## 2. ターゲットユーザー / ユースケース
- 台本テキストを用意し、手軽に解説動画を作成したいユーザー
- オリジナルのキャラクター画像を使用したいユーザー
- 安全にAPIキーを管理したいユーザー

## 3. 機能要件

### 3.1. 台本管理
- **テキスト読み込み**: 既存のテキストファイルを読み込む機能。将来的に .srt 等の字幕形式インポートも検討。
- **台本編集**: 読み込んだテキストを「会話形式」または「ソロ形式」の台本に変換・編集する機能。
    - 話者の割り当て
    - 台詞の調整
- **保存**: 編集した台本を **JSON形式** で保存・読み込み可能にする。

### 3.2. タイムライン・編集
- **自動分割**: 台本をタイムラインに沿って自動的にセグメント(文単位など)に分割する。
- **映像構成**: タイムラインに基づいてキャラクターの動き、音声を配置する。

### 3.3. 素材生成 (AI/外部API連携)
- **字幕生成**: 台本から字幕データを自動生成する。
- **翻訳**: 字幕を英語に翻訳し、英語字幕も生成する (Google API使用)。
- **音声合成**: 
    - Google Text-to-Speech (標準)
    - 将来的にローカルTTS (VOICEVOX等) も対応可能なよう、インターフェースを抽象化する。
- **APIキー管理**: セキュリティ要件に基づき、永続化せずメモリ内のみで保持する (後述)。

### 3.4. 動画出力
- **動画レンダリング**: **MoviePy** を使用し、音声、キャラクター画像、字幕を合成して動画ファイル(.mp4)を出力する。
- **出力設定**: 解像度(1080p等)、フレームレート(30fps/60fps)の設定項目を設ける(初期は固定値でも可)。

## 4. UI仕様 (Windows)
- **フレームワーク**: WinUI 3 (Windows App SDK)
- **メイン画面構成**:
    - **台本エリア**: テキスト編集、話者設定を行う。
    - **プレビューエリア**: 現在の構成でのプレビューを表示。API経由で取得した情報を表示するインタラクティブなUI。
    - **設定エリア**: キャラクター選択、音声設定など。
    - **APIキー入力ダイアログ**: アプリ起動時または初回利用時にモーダル表示。

## 5. 技術アーキテクチャ

UI (C#) と Core (Python) を **HTTP通信 (REST API + SSE)** で連携させる構成を採用する。

### 5.1. 構成概要
- **Frontend**: WinUI 3 (C#)
- **Backend**: Python (FastAPI)
- **通信**:
    - **Request**: REST API (JSON)
    - **Progress**: Server-Sent Events (SSE) - 動画生成進捗などの通知用

### 5.2. プロセス管理
1.  WinUIアプリ起動時に、Pythonバックエンドサーバーをサブプロセスとして起動する。
2.  WinUIアプリ終了時に、Pythonプロセスを確実に終了させる。

### 5.3. セキュリティ要件 (APIキー管理)
**最重要**: APIキーはディスク、環境変数、ログ等に一切保存しない。

**実装フロー**:
1.  WinUI起動 → Pythonサーバー起動 (この時点ではAPIキー未設定)。
2.  ユーザーがWinUI上でAPIキーを入力。
3.  WinUIからPythonサーバーへ、**POSTリクエスト** のBodyまたはHeader経由でAPIキーを送信。
    *   **禁止事項**: サーバー起動時のコマンドライン引数で渡さないこと (タスクマネージャー等で見えるため)。
4.  Pythonサーバーは受け取ったキーを **オンメモリ変数** として保持し、APIリクエスト時のみ使用する。
5.  アプリ終了とともにメモリ解放され、キーは消滅する。

## 6. キャラクター素材仕様

### 6.1. 画像形式
- **形式**: PNG (透過対応)
- **推奨サイズ**: 立ち絵として十分な解像度 (例: 高さ1080px〜1920px程度を推奨)

### 6.2. ファイル構成 (ステートベース)
パーツ合成ではなく、状態ごとの差分画像を切り替える。
複数キャラクターに対応するため、ディレクトリで管理する。

**ディレクトリ構成例**:
```
/Assets
  /Characters
    /Reimu
      reimu_normal_open_close.png  (通常・目開・口閉)
      reimu_normal_open_open.png   (通常・目開・口開)
      reimu_normal_closed_close.png (まばたき)
      config.json (キャラ設定: 表示名、デフォルトボイス等)
    /Marisa
      ...
```

**最低限必要なステート**:
1. デフォルト (目開・口閉)
2. 会話用 (目開・口開)
3. まばたき用 (目閉・口閉)

## 7. 非機能要件・その他
- **パフォーマンス**: 動画生成は時間がかかるため、UIをフリーズさせないよう非同期で実行し、SSEで進捗バーを表示する。
- **エラーハンドリング**: 
    - Pythonサーバー起動失敗時の検知と再試行/エラー表示。
    - ネットワークエラー時のリトライ処理。
