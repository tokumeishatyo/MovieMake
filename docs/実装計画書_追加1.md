# 実装計画書 (機能追加1: キャラクター管理・アニメーション)

## 概要
本計画書は、`docs/機能追加1.md` に基づくキャラクター追加機能およびアニメーション機能の実装手順を定義する。

## 目標
1.  **キャラクター管理**: ユーザーがGUIからキャラクターを追加し、再ビルドなしで利用可能にする。
2.  **アニメーション**: 音声に合わせた口パクと、ランダムな瞬き（目パチ）を実装する。

## Phase 1: キャラクター管理機能 (Frontend & Backend)

### 1. Backend: AssetManagerの改修
*   **変更ファイル**: `backend/services/asset_manager.py`, `backend/main.py`
*   **内容**:
    *   `AssetManager` の初期化時に、アプリケーションのローカルデータフォルダ (`AppData`) のパスを受け取れるようにする。
    *   スキャン対象を「インストールディレクトリ(`backend/assets`)」と「ユーザーデータディレクトリ」の両方に拡張する。

### 2. Frontend: データフォルダ連携の確立
*   **変更ファイル**: `Services/PythonService.cs`
*   **内容**:
    *   Pythonプロセス起動時、環境変数 (`USER_DATA_DIR`) として `Windows.Storage.ApplicationData.Current.LocalFolder.Path` を渡す。

### 3. Frontend: キャラクターインポートUI
*   **変更ファイル**: `Views/ScriptEditorPage.xaml`, `ViewModels/ScriptEditorViewModel.cs`, `Services/FilePickerService.cs`
*   **内容**:
    *   `FilePickerService` に `PickSingleFolderAsync` を追加。
    *   `ScriptEditorViewModel` に `ImportCharacterCommand` を追加。
    *   インポート処理:
        1.  フォルダーピッカーでフォルダを選択。
        2.  選択されたフォルダ内の画像ファイル (`00.png` 等) を `AppData/.../characters/{FolderName}` にコピー。
        3.  コピー完了後、バックエンドのキャラクターリストを再取得 (`InitializeAsync`)。

## Phase 2: アニメーション機能 (Backend)

### 1. VideoGeneratorの改修
*   **変更ファイル**: `backend/services/video_generator.py`
*   **内容**:
    *   `moviepy` の静止画クリップ (`ImageClip`) の代わりに、動的なフレーム生成 (`VideoClip(make_frame=...)`) または `CompositeVideoClip` を使用するロジックに変更。
    *   **AnimationLogic クラス** (または関数) の作成:
        *   入力: 音声クリップ (`AudioClip`), 素材画像パス辞書
        *   処理:
            *   **音声解析**: `audio_clip.to_soundarray()` を使用して、現在の時刻 `t` における音量を取得。しきい値判定で `msg_mouth_open` フラグを設定。
            *   **瞬き制御**: ランダムなタイミングで `msg_eye_closed` フラグを設定 (例: `next_blink_time` を管理)。
            *   **画像選択**: フラグに基づき `00`〜`03` の画像を返す。

## Phase 3: 検証

### テスト項目
1.  **インポート機能**:
    *   任意のフォルダ（`00.png`等を含む）を選択し、アプリ再起動なしでリストに追加されるか。
    *   アプリ再起動後もキャラクターが維持されているか。
2.  **アニメーション出力**:
    *   生成された動画で、音声に合わせて口が動いているか。
    *   時々瞬きをしているか。
    *   画像パターンの不足時にエラーにならずフォールバックするか（`00.png`のみの場合など）。

## スケジュール補足
*   まずは Phase 1 (インポート) を実装し、キャラクター管理基盤を整える。
*   その後、Phase 2 (アニメーション) のロジック実装を行う。
