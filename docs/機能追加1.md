# 機能追加仕様書 1

## 概要
本ドキュメントは、MovieMakeアプリケーションに対する以下の機能追加に関する仕様を定義する。
1.  **キャラクター管理機能**: ユーザーによる動的なキャラクター追加（リビルド不要化）。
2.  **アニメーション機能**: 口パク（リップシンク）と瞬きの実装。

## 1. キャラクター管理機能

### 現状の課題
現在のキャラクター読み込みはアプリのインストールフォルダ（`bin/...`）を参照しているため、新しいキャラクターを追加するにはプロジェクトへのファイル追加とリビルドが必要である。

### 要件
*   ユーザーがGUI上からキャラクターを追加できるようにする。
*   追加されたキャラクターは次回のアプリ起動時も保持される。
*   リビルドなしで即座に動画生成に使用できる。

### 実装方針
*   **保存場所の変更**:
    *   `ApplicationData.Current.LocalFolder`（アプリ固有のデータ保存領域）配下に `UserCharacters` フォルダを作成し、ここをメインの参照先とする。
    *   初期プリセット（Zundamon等）は初回起動時にここへコピーするか、または `AssetManager` が「インストールフォルダ」と「ユーザーフォルダ」の両方をスキャンするように変更する。
*   **UI追加 (SetupPage または ScriptEditorPage)**:
    *   「キャラクター追加」ボタンを設置。
    *   フォルダ選択ダイアログを表示し、キャラクター画像が含まれるフォルダを選択させる。
    *   選択されたフォルダの中身を `UserCharacters` 配下にコピーする。

## 2. アニメーション機能（口パク・瞬き）

### 現状
静止画（1枚絵）のみを表示している。

### 要件
*   **口パク (Lip-Sync)**:
    *   音声（TTS生成音）に合わせて口を開閉させる。
*   **瞬き (Blinking)**:
    *   一定間隔、またはランダムなタイミングで目を瞬きさせる。

### 実装方針
キャラクターの素材構造を以下のように定義し、`VideoGenerator` で合成を行う。

#### 素材仕様 (例)
各キャラクターフォルダに以下の命名規則で画像を配置する。
*   `base.png`: 体と顔のベース（必須）
*   `00.png`: 目（開いている状態） ※`base.png`に含まれる場合は不要だが、分けたほうが綺麗。
*   `01.png`: 目（閉じている状態・瞬き用）
*   `02.png`: 口（閉じている状態）
*   `03.png`: 口（開いている状態）

※ 簡易化のため、今回は **「base.png（体）」+「eyes（目）」+「mouth（口）」** のレイヤー合成、または **「目パチ差分画像」+「口パク差分画像」** の切り替え方式を採用する。
**提案方式**:
簡単な「立ち絵」形式として、**Base（体）の上に、Parts（目・口）を重ねる** 方式とする。

#### アニメーションロジック (Python/MoviePy)
1.  **音声解析**:
    *   生成された音声ファイルの振幅（ボリューム）を解析し、しきい値を超えているフレームでは「口が開いた画像」、それ以外は「閉じた画像」を選択する。
2.  **瞬き生成**:
    *   ランダムな間隔（例: 3〜5秒毎）で数フレームだけ「閉じた目」の画像に切り替える。
3.  **動画合成**:
    *   MoviePyの `CompositeVideoClip` を使用し、フレームごとに適切な画像を生成・合成して動画化する。

## 画面等の変更
### Script Editor
*   行ごとのキャラクター選択時に、ユーザーが追加したキャラクターもリストに表示されること。
*   （将来機能）プレビュー機能など。

## 開発ステップ
1.  **Asset Manager改修**: ユーザーフォルダ対応、画像インポート機能API。
2.  **UI改修**: キャラクター追加機能の実装。
3.  **Video Generator改修**: 音声解析ロジック、レイヤー合成ロジックの実装。
