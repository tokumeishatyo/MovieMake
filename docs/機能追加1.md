# 機能追加仕様書 1

## 概要
本ドキュメントは、MovieMakeアプリケーションに対する以下の機能追加に関する仕様を定義する。
1.  **キャラクター管理機能**: ユーザーによる動的なキャラクター追加（リビルド不要化）。
2.  **アニメーション機能**: 口パク（リップシンク）と瞬きの実装。

## 1. キャラクター管理機能

### 現状の課題
現在のキャラクター読み込みはアプリのインストールフォルダ（`bin/...`）を参照しているため、新しいキャラクターを追加するにはプロジェクトへのファイル追加とリビルドが必要である。

### 要件
*   ユーザーがGUI上からキャラクターを追加できるようにする。
*   追加されたキャラクターは次回のアプリ起動時も保持される。
*   リビルドなしで即座に動画生成に使用できる。

### 実装方針
*   **保存場所の変更**:
    *   `ApplicationData.Current.LocalFolder`（アプリ固有のデータ保存領域）配下に `UserCharacters` フォルダを作成し、ここをメインの参照先とする。
    *   初期プリセット（Zundamon等）は初回起動時にここへコピーするか、または `AssetManager` が「インストールフォルダ」と「ユーザーフォルダ」の両方をスキャンするように変更する。
*   **UI追加 (SetupPage または ScriptEditorPage)**:
    *   「キャラクター追加」ボタンを設置。
    *   フォルダ選択ダイアログを表示し、キャラクター画像が含まれるフォルダを選択させる。
    *   選択されたフォルダの中身を `UserCharacters` 配下にコピーする。

## 2. アニメーション機能（口パク・瞬き）

### 現状
静止画（1枚絵）のみを表示している。

### 要件
*   **口パク (Lip-Sync)**:
    *   音声（TTS生成音）に合わせて口を開閉させる。
*   **瞬き (Blinking)**:
    *   一定間隔、またはランダムなタイミングで目を瞬きさせる。

### 実装方針
キャラクターの素材構造を以下のように定義し、`VideoGenerator` で合成を行う。

#### 素材仕様 (変更)
パーツ分けではなく、以下の4パターンの差分画像を各キャラクターフォルダに配置する命名規則とする。

*   `00.png`: **目:開 / 口:閉** (通常状態・ベース)
*   `01.png`: **目:開 / 口:開** (発話中)
*   `02.png`: **目:閉 / 口:閉** (瞬き)
*   `03.png`: **目:閉 / 口:開** (瞬き＋発話中 ※レアケースだが整合性のため用意)

#### アニメーションロジック (Python/MoviePy)
フレーム毎に「目の状態」と「口の状態」を決定し、対応する画像を選択する。

1.  **口の状態 (Mouth State)**:
    *   音声ファイルの振幅を取得。
    *   しきい値以上 → **開 (Open)**
    *   しきい値未満 → **閉 (Closed)**

2.  **目の状態 (Eye State)**:
    *   ランダムなタイミング（例: 3〜5秒毎）でフラグを立てる。
    *   瞬き期間（例: 0.1〜0.2秒） → **閉 (Closed)**
    *   それ以外 → **開 (Open)**

3.  **画像選択ロジック**:
    *   目:開 & 口:閉 → `00.png`
    *   目:開 & 口:開 → `01.png`
    *   目:閉 & 口:閉 → `02.png`
    *   目:閉 & 口:開 → `03.png`

    ※ 画像が存在しない場合は `00.png` (通常) でフォールバックする。

## 画面等の変更
### Script Editor
*   行ごとのキャラクター選択時に、ユーザーが追加したキャラクターもリストに表示されること。
*   （将来機能）プレビュー機能など。

## 開発ステップ
1.  **Asset Manager改修**: ユーザーフォルダ対応、画像インポート機能API。
2.  **UI改修**: キャラクター追加機能の実装。
3.  **Video Generator改修**: 音声解析ロジック、レイヤー合成ロジックの実装。
