# 実装計画書

## 1. 概要
本プロジェクトでは、WinUI 3 (C#) をフロントエンド、FastAPI (Python) をバックエンドとする動画作成アプリケーションを開発します。
開発は以下のフェーズに分けて段階的に進めます。

## 2. 開発フェーズ

### フェーズ 1: プロジェクト基盤の確立 (Project Skeleton & IPC)
**目標**: WinUIアプリからPythonサーバーを起動し、正常に通信(ヘルスチェック)できる状態にする。

1.  **Python環境の構築**
    *   FastAPI, Uvicornの依存関係定義 (`requirements.txt`)
    *   Hello WorldレベルのAPIサーバー実装 (`backend/main.py`)
2.  **WinUI 3プロジェクトの整備**
    *   MVVMパターンの基本構成 (CommunityToolkit.Mvvm導入)
    *   Pythonプロセス管理クラス (`PythonService`) の実装
        *   起動/終了処理
        *   APIキーのインメモリ保持ロジック
3.  **IPC通信テスト**
    *   WinUI起動 → Python起動 → ヘルスチェックAPI叩く → 成功表示
    *   WinUI終了 → Python終了確認

### フェーズ 2: データモデルと台本UI実装 (Core Data & UI)
**目標**: 台本を作成・編集し、JSONとして保存・読み込みができる。

1.  **データモデル定義 (共通)**
    *   台本 (Script), 行 (Line), キャラクター (Character) のJSONスキーマ定義
2.  **台本編集UI (WinUI)**
    *   テキスト入力エリアとタイムライン(リスト)表示
    *   話者設定のプルダウン実装
3.  **ファイルI/O**
    *   `ScriptManager` クラスの実装 (Load/Save)
    *   JSONシリアライズ/デシリアライズ実装

### フェーズ 3: Pythonコアロジック - 素材管理 (Core Logic)
**目標**: Python側で画像パスの解決と音声合成(モック/Google)ができる。

1.  **キャラクターアセット管理**
    *   画像ディレクトリ構造の整備 (`Assets/Characters/...`)
    *   ステート(感情・口パク)に応じた画像パス返却APIの実装
2.  **音声合成 (TTS) 基盤**
    *   TTSインターフェースの定義 (将来のVOICEVOX対応のため)
    *   Google TTSの実装 (gTTS利用) と音声ファイル生成
    *   API実装: テキストを受け取り、音声ファイルのパス(またはバイナリ)を返す

### フェーズ 4: 動画生成とプレビュー (Video Gen & Integration)
**目標**: 動画ファイルが出力され、進捗が表示される。

1.  **動画生成ロジック (MoviePy)**
    *   `VideoService` の実装
    *   画像、音声、字幕(Srt生成)の合成処理
2.  **進捗通知 (SSE)**
    *   FastAPI側へのSSEエンドポイント追加
    *   MoviePyのコールバックフック、SSEへのプログレス送信
    *   WinUI側でのSSE受信・プログレスバー表示
3.  **UI結合**
    *   プレビューボタン(静止画/音声確認)
    *   エクスポートボタン(動画生成開始)

### フェーズ 5: 検証と仕上げ (Verification & Polish)
**目標**: 実用レベルの品質確保。

1.  **セキュリティ検証**: APIキーがメモリ外に漏れていないか確認
2.  **結合テスト**: シナリオ(起動〜作成〜出力〜終了)を通しで行う
3.  **UI調整**: レイアウト、エラー表示の親切化

## 3. 検証計画 (Verification Plan)

### 自動テスト
- **Python**: `pytest` を使用し、各APIエンドポイントの単体テストを行う(特にロジック部分)。
- **C#**: `MSTest` を使用し、ViewModelのロジック(バリデーション等)をテストする。

### 手動テスト
1.  **起動・終了テスト**: タスクマネージャーを開きながら、ゾンビプロセスが残らないか確認。
2.  **APIキー漏洩確認**: プロセスダンプ以外のファイルシステムを検索し、キーが平文保存されていないか確認。
3.  **生成物確認**: 出力されたMP4が再生可能か、音ズレがないか確認。

## 4. レビュールール
- 原則として、各フェーズ完了時にレビュアー(Claude)の確認を受ける。
- 大きな設計変更が必要になった場合は、即座に機能仕様書を更新する。
